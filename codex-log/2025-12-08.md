# Formula field flow and current implementation

## Flow overview
- **Categories:** math, string, date; category constrains allowed functions.
- **Function palette:** Whitelisted metadata per function (name, category, returnType, arg specs, variadic flags).
- **Input options:** Frontend sends a structured `expressionTree` (function/field/literal nodes).
- **Normalization:** Function names canonicalized, root tagged with category, `dependsOnFields` auto-collected from field references, schemaVersion set.
- **Validation:** Tree validated against palette — function exists, category matches, arg count within bounds, arg types match, field references present/allowed, node/depth limits enforced.
- **Storage shape:** `configShape` persists `category`, `expressionTree`, `dependsOnFields`, `schemaVersion` (structured JSON, no free-form code).

## What’s implemented now
- Added formula types, palette, validator, and normalizer under `src/api/client/object-related/crm-object-field/formula/`.
- Formula `configShape` supports category, expressionTree, dependsOnFields, schemaVersion.
- `CrmObjectFieldService.createField` now normalizes and validates formula configs before saving and stores the canonical tree/metadata.
- README updated with the new formula config contract and an example payload/tree.
- Added `POST /crm-object-field/formula/normalize` to validate a formula `expressionTree` into the canonical tree + metadata and return validation results for the frontend.
